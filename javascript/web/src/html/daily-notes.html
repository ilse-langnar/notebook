<div data-component-id="daily-notes" id="daily-notes" x-transition x-data="{ days: [] }" x-init="days.push( ilse.utils.get_unique_date_id().slice(0, 8) )" class="flex" >

    <div class="left-sidebar" x-data="{ is_open: false, tab: '', html: '' }" :style=" is_open ? 'flex-basis: 20%;' : '' " >

        <div class="float-left" >

            <div style="float: right; width: 200px; height: 200px; border: 1px solid green; overflow: hidden;" x-show="is_open" x-html="ilse.markdown.render(html)" > </div>

            <img :src=" is_open ? window.ilse.require('arrow-narrow-left.svg') : window.ilse.require('arrow-narrow-right.svg')" style="width: 20px; cursor: pointer;" @click="is_open = !is_open; tab = '' "/>

            <br/>
            <br/>

            <img :src="window.ilse.require('folders.svg')"  style="width: 20px; cursor: pointer; display: block; " @click="tab = 'filesystem'; is_open = !is_open " />
            <img :src="window.ilse.require('settings.svg')" style="width: 20px; cursor: pointer; display: block; " @click="tab = 'settings'; is_open = !is_open " />

            <br/>
            <br/>

            <template x-for="( note, index ) in favorites" :key=" 'note' + index" x-data="{favorites:window.ilse.query('#public')}" x-init="window.ilse.Messager.on('~ilse',(action)=> { if( action === 'loaded' ) { favorites = window.ilse.query_regexp( /#public/ ); } })" >

                <div >

                    <img class="cursor-pointer" @click="is_open = !is_open; html = note.content; if( $event.shiftKey ) { is_open = false; ilse.components.create_window({ title: 'Component', pure: true, html: ilse.markdown.render(note.content)}) }; if( $event.ctrlKey ) { is_open = false; ilse.htmls.modal(note.id, ilse.markdown.render(note.content) ) }" :src="window.ilse.utils.get_string_favicon(note.content)" />

                </div>
            </template>
        </div> <!-- Hidden -->

    </div>

    <div id="daily-notes" style="overflow: auto !important; height: 91vh; width: 100%; margin: 0 auto; flex: 1; flex-basis: 96%;" >

        <template x-for="( day, index ) in days" :key="index" x-init="if( !days.length ) { days.push( ilse.utils.get_unique_date_id().slice(0, 8) ) }" >

            <div x-data="{ list: window.ilse.query_regexp( new RegExp( '^' + day, 'ig') ) || [] }" x-init="window.ilse.Messager.on('~ilse', (action) => { if( action === 'loaded' ) { list = window.ilse.query_regexp( '^' + day, 'ig' ) } })" >

                <div style="margin: 0 auto; width: 400px; " >
                    <img style="width: 30px; cursor: pointer;" :src="ilse.require('trash.svg')" @click="days.splice( index, 1 )" />
                    <span style="font-size: 30px;" x-text="window.ilse.utils.yyyymmddhhss_to_pretty(day)" > </span>
                    <img style="width: 30px; cursor: pointer; " :src="ilse.require('lupe.svg')" />
                </div>

                <template x-for="(note, index) in list" style="border-left: 1px solid #000;" >

                    <!-- Should I have notes.style? -->
                    <!-- <div :id="note.id" class="flex my-1" :style=" 'margin-left:' + (ilse.notes.list[note.id].depth * 20) + 'px;' " > -->
                    <!-- <div :id="note.id" :style="ilse.notes.list[note.id].style + 'display: flex; height: auto;' " x-init="ilse.notes.list[note.id].style = ilse.notes.list[note.id].depth * 20 + 'px'; " > -->
                    <div x-data="{ depth: ilse.notes.list[note.id].depth }" :id="note.id" :style=" 'margin-left:' + (depth * 20) + 'px;' " > 

                        <div class="bullet" style="flex: 1; display: block; float: left; margin-right: 6px;" :title="ilse.utils.get_human_readable_creation_date(note.id)" > &bull; </div>

                        <div x-show="note.is_editing" style="flex: 1; " :id=" note.id + '-edit' " contentEditable
                             x-text="ilse.notes.list[note.id].content" 
                             @blur="note.is_editing = false; ilse.notes.list[note.id].content = $event.target.innerText; ilse.notes.save()"

                             @keydown.tab.prevent="let shift = $event.shiftKey
                                if( shift ) {
                                    ilse.notes.list[note.id].depth--
                                    depth--
                                } else {
                                    depth++
                                    ilse.notes.list[note.id].depth++
                                }
                             " 

                             @keydown.ctrl.up="let copy = index; let previous_index = --copy;
                             if( list[previous_index] ) {
                                 let dom  = document.getElementById( list[previous_index].id );
                                 if( dom ) {
                                     list[previous_index].is_editing = true
                                     document.activeElement.blur()
                                     setTimeout( () => { let dom  = document.getElementById( list[previous_index].id + '-edit' ); if( dom ) dom.focus(); }, 1 )
                                 }
                             }"

                             @keydown.ctrl.down="let copy = index; let next_index = ++copy;
                             if( list[next_index] ) {
                                 let dom  = document.getElementById( list[next_index].id );
                                 if( dom ) {
                                     list[next_index].is_editing = true
                                     document.activeElement.blur()
                                     setTimeout( () => { let dom  = document.getElementById( list[next_index].id + '-edit' ); if( dom ) dom.focus(); }, 1 )
                                 }
                             }"

                             > </div>

                        <div x-show="!note.is_editing" style="flex: 1; " :id=" note.id + 'render'" :data-note-id="note.id" x-html="ilse.markdown.render(ilse.notes.list[note.id].content)" @link-click="if( $event.detail.id === note.id ) ilse.htmls.modal( ilse.htmls.render( 'references', { file: $event.detail.link } ), { width: '70%', height: '70%' })" @click="note.is_editing = true; setTimeout( () => {let dom = document.getElementById( note.id + '-edit' ); dom.focus() }, 10 ) " > </div>

                    </div>


                </template>


                <button x-show="index === days.length - 1" class="load-more" style="padding: 7px; border-radius: var( --border-radius ); margin: 0 auto; text-align: center; margin-top: 10px; " @click="let DAY = day;
                    let year = DAY.substr( 0, 4 );
                    let month = DAY.substr( 4, 2 );
                    let _day = Number(DAY.substr( 6, 2 ) );

                    let copy = _day;
                        copy -= 1;

                    if( copy === 0 ) {
                        days.push( year + --month + '31' )
                    } else {
                        if( copy < 10 ) {
                            days.push( year + month + '0' + --_day )
                        } else {
                            days.push( year + month + --_day )
                        }
                    }

                    "> Load More </button>
                <br>

            </div>


        </template>

        <br/>
    </div>

</div>
<style>

.left-sidebar {
    height: 100vh;
    width: 20px !important;
    flex: 1;
    flex-basis: 1%;
    padding: 5px;
    overflow: ;
}

.bullet {
    margin-top:   -5px;
    text-align:   center;
    cursor:       pointer;
    color:        #a3a3a3;
    color:        var( --text-color );
    font-size: 1.5em;
    cursor:       pointer;

    margin-right: 7px;
    width: 10px;
    height: 10px;
}

#daily-notes .edit:focus {
    outline: none;
}

#daily-notes .load-more {
    display: block;
}

</style>

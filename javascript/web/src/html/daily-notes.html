<div data-component-id="daily-notes" id="daily-notes" x-transition x-data="{ days: [], is_leftsidebar_open: true, is_rightsidebar: false, mode: 'linear', }" x-init="days.push( ilse.utils.get_unique_date_id().slice(0, 8) )" class="flex" >

    <!-- Left Sidebar -->
    <div x-show="is_leftsidebar_open" class="left-sidebar" :style=" is_leftsidebar_open ? 'flex-basis: 20%;' : 'flex-basis: 3%;' " >

        <div style="" >

            <br/>
            <br/>

            <!-- <p x-text="$store.store.notes" :title="JSON.stringify($store)" :key="$store.key" ></p> -->
            <h3 align="center" style="cursor: pointer; background: var( --text-color ); color: var( --background-color );" class="" > Daily Notes </h3>
            <h3 align="center" style="cursor: pointer;" @click="ilse.commands.run('open-study-tab')" > Study </h3>
            <h3 align="center" style="cursor: pointer;" @click="ilse.commands.run('open-todos-modal')" > Todos </h3>
            <h3 align="center" style="cursor: pointer;" class="" > Calendar </h3>
            <h3 align="center" style="cursor: pointer;" @click="window.ilse.tabs.add_with_component('pan', { title: 'Pan', autoselect: true }) /*ilse.commands.run('open-pan')*/ " > Exploration </h3>
            <hr>
            <template x-for="( note, index ) in favorites" :key=" 'note' + index" x-data="{ favorites:window.ilse.query( '[[Public/' ) }" >

                <template x-for="( link, link_index ) in ilse.utils.extract_markdown_links_from_string(note.content)" :key="'link-' + link_index" >
                    <p class="favorite" :title=" 'Click to open: ' + link" x-show="link.indexOf('[[Public/') !== -1" style="margin: 5px 5px; background: var( --text-color ); color: var( --background-color ); padding: 5px; border-radius: var( --border-radius );" x-text="link.replace('[[Public/', '').replace(']]', '') " > </p>
                </template> 

            </template>

        </div>

    </div>
    <!-- Left Sidebar -->

    <div id="notes" style="overflow-y: auto !important; overflow-x: hidden !important; margin-left: 5px; height: 88vh; box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px; margin-right: 10px; flex: 1; flex-basis: 100%; border-radius: var( --border-radius ); background: var( --background-color ); "  >

        <div style="padding: 5px;" >
            <img :src=" is_leftsidebar_open ? window.ilse.require('arrow-narrow-left.svg') : window.ilse.require('arrow-narrow-right.svg')" style="width: 20px; cursor: pointer;" @click="is_leftsidebar_open = !is_leftsidebar_open; " />
        </div>

        <template x-for="( day, index ) in days" :key="index" x-init="if( !days.length ) { days.push( ilse.utils.get_unique_date_id().slice(0, 8) ) }" >

            <div x-data="{ list: window.ilse.query_regexp( new RegExp( '^' + day, 'ig') ) || [] }" x-init="window.ilse.Messager.on('~ilse', (action) => { if( action === 'loaded' ) { list = window.ilse.query_regexp( '^' + day, 'ig' ) } })" style="padding: 40px;" >

                <h1 style="center !important; color: var( --text-color );" x-text="window.ilse.utils.yyyymmddhhss_to_pretty(day)" > </h1>
                <br>

                <template x-for="(note, index) in list" x-init="ilse.Messager.on('~notes', (action,payload) => { if(action === 'added'){list.push( ilse.notes.list[payload.target] ) }  })" >

                    <div> <!-- Root -->
                        <div x-show="note.content.indexOf('#hidden') === -1" x-data="{ depth: ilse.notes.list[note.id].depth, content: ilse.notes.list[note.id].content }" x-note-id="note.id" :id="note.id" :style=" 'margin-left:' + (depth * 20) + 'px;' " > 

                            <!-- Bullet -->
                            <div class="bullet" @click.shift="ilse.tabs.add( ilse.render('pan', { list: ilse.query(note.id) }), { title: 'Pan', autoselect: true })" :title="ilse.utils.get_human_readable_creation_date(note.id)" > &bull; </div>

                            <!-- Editing -->
                            <div x-show="note.is_editing" x-note-id="note.id" :id=" note.id + '-edit' " :key="ilse.notes.list[note.id].content" class="no-outline edit" contentEditable
                                 x-text="ilse.notes.list[note.id].content" 
                                 @blur="note.is_editing = false; ilse.notes.list[note.id].content = $event.target.innerText; ilse.notes.save()"

                                 @keydown.enter.prevent="let new_note = ilse.add_after( '', ilse.notes.list[note.id].depth, note.id );
                                 setTimeout( () =>{
                                     note.is_editing = false;
                                     let dom = document.getElementById(new_note) ;
                                     dom.focus()
                                 }, 1000 ) " 

                                 @keydown.esc.prevent="document.activeElement.blur(); note.is_editing = false;"

                                 @keydown.tab.prevent="let shift = $event.shiftKey
                                    if( shift ) {
                                        ilse.notes.list[note.id].depth--
                                        depth--
                                    } else {
                                        depth++
                                        ilse.notes.list[note.id].depth++
                                    }
                                 " 

                                 @keydown.ctrl.up="let copy = index; let previous_index = --copy;
                                 if( list[previous_index] ) {
                                     let dom  = document.getElementById( list[previous_index].id );
                                     if( dom ) {
                                         list[previous_index].is_editing = true
                                         document.activeElement.blur()
                                         setTimeout( () => { let dom  = document.getElementById( list[previous_index].id + '-edit' ); if( dom ) dom.focus(); }, 1 )
                                     }
                                 }"

                                 @keydown.ctrl.down="let copy = index; let next_index = ++copy;
                                 if( list[next_index] ) {
                                     let dom  = document.getElementById( list[next_index].id );
                                     if( dom ) {
                                         list[next_index].is_editing = true
                                         document.activeElement.blur()
                                         setTimeout( () => { let dom  = document.getElementById( list[next_index].id + '-edit' ); if( dom ) dom.focus(); }, 1 )
                                     }
                                 }"

                                 > </div>
                                <!-- Editing -->

                            <!-- Displaying -->
                            <div x-show="!note.is_editing" class="render" :key="ilse.notes.list[note.id].content" x-note-id="note.id" :id=" note.id + 'render'" :data-note-id="note.id" :title="content" x-html="ilse.markdown.render(ilse.notes.list[note.id].content)"
                                                                                                                                                                                                             @link-click="console.log('$event.detail.id -> ', $event.detail.id); console.log('note.id -> ', note.id); console.log('$event.detail.id === note.id', $event.detail.id === note.id); console.log(' $store.links.indexOf($event.detail.link) === -1 -> ', $store.links.indexOf($event.detail.link) === -1); if( $event.detail.id === note.id && $store.links.indexOf($event.detail.link) === -1 ) { let links = ilse.store('links'); console.log('@@@>> links -> ', links); links.push($event.detail.link); ilse.store('links', links); }"

                                 @click="if( $event.target.type === 'checkbox' ) {
                                    ilse.notes.list[note.id].content.replace( '- [ ]', '- [x]' )
                                    note.is_editing = false;
                                 } else {
                                    if( !$event.shiftKey ) {
                                        note.is_editing = true;
                                        setTimeout( () => {let dom = document.getElementById( note.id + '-edit' ); dom.focus() }, 10 )
                                    }
                                 } " > </div>
                                <!-- Displaying -->


                        </div>

                        <!-- Last Bullet -->
                        <div class="ghost-bullet" x-show="index === list.length - 1" style="margin-left: 0px !important;" > 
                            <div class="bullet" style="flex: 1; flex-shrink: 2; " > &bull; </div> 
                            <div class="camp"   style="flex: 1; padding-left: 15px; min-width: 100px; " contentEditable @blur="let new_note = null; let text = $event.target.innerText; if( text ) { new_note = ilse.add_note( text ); ilse.save() };  $event.target.innerText = ''; " @keydown.enter.prevent="document.activeElement.blur(); ilse.notes.focus( list[list.length -1].id )" > </div>
                        </div>

                    </div> <!-- Root -->

                </template>

                <!-- First note of the day -->
                <div class="ghost-bullet" x-data="{ list: ilse.query( ilse.utils.get_unique_date_id().slice(0, 8) ) }" x-show="!list.length" style="margin-left: 0px; min-height: 30px; height: fit-content; color: var( --text-color ); " >
                    <div class="bullet" style="flex: 1; flex-shrink: 2; " > &bull; </div> 
                    <div class="camp"   style="flex: 1; padding-left: 15px; min-width: 100px; " contentEditable @blur="let new_note = null; let text = $event.target.innerText; console.log('text -> ', text ); if( text ) { new_note = ilse.add_note( text ); ilse.save() };  $event.target.innerText = ''; " @keydown.enter.prevent="document.activeElement.blur();" @keydown.esc.prevent="$event.target.innerText = ''; document.activeElement.blur()" > </div>
                    <br>
                </div>

                <button x-show="index === days.length - 1" class="load-more" style="padding: 7px; border-radius: var( --border-radius ); margin: 0 auto; text-align: center; margin-top: 10px; " @click="let DAY = day;
                    let year = DAY.substr( 0, 4 );
                    let month = DAY.substr( 4, 2 );
                    let _day = Number(DAY.substr( 6, 2 ) );

                    let copy = _day;
                        copy -= 1;

                    if( copy === 0 ) {
                        days.push( year + --month + '31' )
                    } else {
                        if( copy < 10 ) {
                            days.push( year + month + '0' + --_day )
                        } else {
                            days.push( year + month + --_day )
                        }
                    }

                    "> Load More </button>
                <br>

            </div>

        </template>
        <br/>
    </div>
</div>
<style>

#daily-notes {
    height: 91vh;
    height: 99vh;
}

    #daily-notes .note {
        border-left: 1px solid #000;
    }

    #daily-notes .left-sidebar {
        height: 88vh;
        width: 20px !important;
        margin: 0px 5px;
        overflow: hidden;
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        border-radius: var( --border-radius );
        background: var( --background-color ); 
        border: 0 !important;
    }

        #daily-notes .left-sidebar .favorite {
            cursor: pointer;
        }

    #daily-notes .right-sidebar {
        height: 88vh;
        width: 20px !important;
        margin: 0px 4px;
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        border-radius: var( --border-radius );
        background: var( --background-color ); 
        border: 0 !important;
        padding: 10px;
    }

    #daily-notes .bullet {
        margin-top:   -5px;
        text-align:   center;
        cursor:       pointer;
        color:        #a3a3a3;
        color:        var( --text-color );
        font-size: 1.5em;
        cursor:       pointer;
        margin-right: 7px;
        width: 10px;
        height: 10px;


        flex: 1;
        display: block;
        float: left;
        margin-right: 6px;
    }

    #daily-notes .edit {
        flex: 1; 
        min-width: 100px;
        min-height: 30px;
        padding-left: 15px;
    }

        #daily-notes .edit:focus {
            outline: none;
            border-bottom: 1px solid var( --text-color );
        }

#daily-notes .render {
    flex: 1;
    /*min-width: 100px;*/
    width: fit-content;
    border: 1px solid transparent;;
    min-height: 30px;
    padding-left: 15px;
}

#daily-notes .load-more {
    display: block;
    color: var( --text-color );
    background: var( --background-color );
}

#daily-notes .ghost-bullet {
    clear: both;
    min-height: 30px;
    height: fit-content;
}

   #daily-notes .ghost-bullet .camp {
        flex: 1;
        height: 32px;
    }

        #daily-notes .ghost-bullet .camp:focus {
            outline: none !important;
            border-bottom: 1px solid var( --text-color );
        }

    #daily-notes .ghost-bullet .bullet {
        flex: 1;
        display: block;
        float: left;
        margin-right: 6px;
    }

#daily-notes .page-tab {
    cursor: pointer;
}

</style>

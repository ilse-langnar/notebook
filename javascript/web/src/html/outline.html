<div data-ilse-id="outline.html" data-ilse-icon="point.svg" >

    <style>
        .load-more {

            background-color: #000;
            background-color: var( --secondary );

            color: #fff;
            color: var( --primary );

            padding: 10px;

            border: 1px solid #000;

            border-radius: 5px;
            font-size: 12px;
            font-weight: 400;
            text-transform: uppercase;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            display: block;
            margin: 0 auto;
        }
    </style>
    <!-- x-init="api.on('~notes', payload => { if( payload.action === 'added' && payload.index === null ) { props.list.push( payload.id ) } })" -->

    <div id='outline' :style="props.style" data-ilse-props >

        <template x-for="(note_id, index) in props.list" :key="note_id" >

            <!-- <div :id="note_id" :style=" 'margin-left:' + (note.depth * 20) + 'px;' " > -->
            <div :id="note_id" :style=" 'margin-left:' + (depth * 20) + 'px !important;' " x-data="{ content: api.markdown(api.notes.list[note_id].content), depth: api.notes.list[note_id].depth }" >

                <!-- x-text="api.notes.list[api.utils.get_note_root(note_id)].content.indexOf('#hidden/collapsed') !== -1? '&ast;' : '&bull;' -->
                <!-- Bullet -->
                <span
                    id=" note_id '-bullet' "
                    class="bullet"
                    :title="api.utils.get_bullet_description(note_id, api.notes.list[note_id] )"
                    @click="navigator.clipboard.writeText(note_id); api.notify('Coped', 'Copied!', 'Copied: ' + note_id + ' To your clipboard' ); " > &bull; </span>

                <!-- Editing -->
                <div 
                     :id="note_id + '-content' "
                     :key="note_id"
                     class="no-outline content"

                     x-html="content"


                     @click="if( $event.target.type === 'checkbox' ) {
                            let normalized  = api.notes.list[note_id].content.replace( '[ ]', '[x]' )
                                api.notes.list[note_id].content = normalized
                            api.store('autosave', 60000);
                     }"

                     @dblclick="$el.setAttribute('contentEditable', true); content = api.notes.list[note_id].content; $el.focus()"

                     @link-click="if( $event.detail.id === note_id && $store.links.indexOf($event.detail.link) === -1 ) { console.log('$event.detail -> ', $event.detail); $store.tabs.add_component('references.html', 'References', { file: $event.detail.link }) }"

                     @keydown.enter.prevent="let note = api.notes.add( ' ' ); props.list.push(note); setTimeout( ()  => { 
                            let dom = document.getElementById(note + '-content');
                            let next_id = props.list[ props.list.indexOf(note) ] 
                            document.activeElement.blur();
                            $el.removeAttribute('contentEditable');
                            dom.setAttribute('contentEditable', true);
                            dom.innerText = api.notes.list[next_id].content; 
                            dom.focus() ;
                        }, 1); /*@@@@@@@@@@@@@@@@@@@@@*/ /*let id = api.utils.get_note_id(); api.notes.list[id] = { content: '', depth: api.notes.list[note_id].depth, id: id, source: 'll' , after: note_id }; list.push(id); list = api.utils.move_array_item( props.list, props.list.length -1, ++index); let move_notes = api.store('move_notes'); move_notes.push({ parent: note_id, child: id }); api.store('move_notes', move_notes); setTimeout( () => { api.emit('~focus', id)}, 10 );*/ "

                     @blur="$el.removeAttribute('contentEditable'); document.activeElement.blur(); let lcontent = content; api.notes.list[note_id].content = $el.innerText; content = api.markdown($el.innerText); /*Updates store*/ /*content = api.markdown(api.notes.list[note_id].content);*/ /*api.notes.list[note_id].content = $event.target.innerText; note.content = api.notes.list[note_id].content; api.store('autosave', 60000) */ "

                     @keydown.esc.prevent=" document.activeElement.blur(); $el.removeAttribute('contentEditable'); api.notes.list[note_id].content = content; /*Updates store*/ /*content = api.markdown(api.notes.list[note_id].content);*/ /*api.notes.list[note_id].content = $event.target.innerText; note.content = api.notes.list[note_id].content; api.store('autosave', 60000) */ "

                     @keydown.tab.prevent="let shift = $event.shiftKey
                        if( shift ) {
                            if( depth === 0 ) return
                            api.notes.list[note_id].depth--
                            depth = api.notes.list[note_id].depth
                        } else {

                            let copy          = Number(index)
                                copy = copy - 1

                            let previous_depth = api.notes.list[list[copy]].depth
                            if( depth > previous_depth ) return

                            api.notes.list[note_id].depth++
                            depth = api.notes.list[note_id].depth
                        }
                     "

                     @keydown.ctrl.up="let copy = index; let previous_index = --copy;
                     let previous_id = props.list[previous_index] 

                     if( previous_id ) {

                         let dom  = document.getElementById( previous_id + '-content' );

                        // out
                         document.activeElement.blur()
                         $el.removeAttribute('contentEditable')

                        // in
                         dom.setAttribute('contentEditable', true)
                         dom.innerText = api.notes.list[previous_id].content
                         dom.focus() 
                     }"

                     @keydown.ctrl.down="let copy = index; let previous_index = ++copy;
                     let next_id = props.list[previous_index] 

                     if( next_id ) {

                         let dom  = document.getElementById( next_id + '-content' );

                        // out
                         document.activeElement.blur()
                         $el.removeAttribute('contentEditable')

                        // in
                         dom.setAttribute('contentEditable', true)
                         dom.innerText = api.notes.list[next_id].content
                         dom.focus() 
                     }"

                     > </div>

                <!-- First Bullet -->
            </div>
        </template>

    </div>

    <style>
    #outline {
        height: 91vh;
        height: 99vh;
        height: auto;
        /*padding: 10px;
        overflow: auto;
        height: 90vh; */
    }

        #outline .note {
            border-left: 1px solid #000;
        }

        #outline .content:hover {
            text-decoration: underline;
        }

        #outline .content {
            padding-left: 10px;
        }

        #outline .bullet {
            margin-top:   -5px;
                margin-top:   0px;
            text-align:   center;
            cursor:       pointer;
            color:        #a3a3a3;
            color:        var( --secondary );
            /* font-size: 1.5em; */
            width: 20px;
            cursor:       pointer;
            margin-right: 0px;
            margin-right: 7px;
            width: 10px;
            height: 10px;

            flex: 1;
            display: block;
            float: left;
            margin-right: 6px;
        }

        #outline .edit {
            flex: 1;
            min-width: 100px;
            min-height: 30px;
            padding-left: 15px;
        }

            #outline .edit:focus {
                outline: none;
                content: "LLLLLLL";
            }

    #outline .render {
        flex: 1;
        /*min-width: 100px;*/
        width: fit-content;
        border: 1px solid transparent;;
        min-height: 30px;
        min-width: 100px;
        padding-left: 15px;
    }

    #outline .ghost-bullet {
        clear: both;
        min-height: 30px;
        height: fit-content;
    }

           #outline .ghost-bullet .camp {
                flex: 1;
                height: 32px;
            }

                #outline .ghost-bullet .camp:focus {
                    outline: none !important;
                    border-bottom: 1px solid var( --secondary );
                }

            #outline .ghost-bullet .bullet {
                flex: 1;
                display: block;
                float: left;
                margin-right: 6px;
            }

    </style>
</div>
